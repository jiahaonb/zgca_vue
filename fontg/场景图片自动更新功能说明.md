# 🎨 场景图片自动更新功能说明

## ✨ 功能概述

系统已升级为智能的场景图片生成模式：

- **每3轮对话自动触发**：系统后台自动生成新的场景图片
- **后台生成**：不阻塞用户交互，无前端提示
- **基于对话历史**：使用所有历史对话记录作为图片生成的文本提示
- **自动更新显示**：前端每10秒检查并自动更新最新图片

## 🔄 工作机制

### 1. 对话轮次计数

- 系统自动跟踪当前对话轮次
- 每完成一轮AI回应后增加计数器
- 当轮次数达到3的倍数时触发图片生成

### 2. 后台图片生成

```
第1轮对话 → 使用初始场景图片
第2轮对话 → 继续使用初始图片
第3轮对话 → 🎨 触发后台图片生成
第4轮对话 → 可能已更新为新图片
第5轮对话 → 继续使用当前图片
第6轮对话 → 🎨 再次触发后台生成
...
```

### 3. 图片生成逻辑

**输入内容**：

- 场景设定
- 剧情大纲
- 所有历史对话记录（完整对话发展）

**生成策略**：

- 体现场景演变和对话发展
- 包含所有参与角色的状态变化
- 反映当前剧情进展阶段
- 营造符合对话发展的整体氛围

### 4. 前端自动更新

- 每10秒检查是否有新图片生成
- 检测到新图片时自动更新显示
- 静默更新，不干扰用户交互

## 🎯 使用体验

### 用户视角

1. **无感知生成**：不会有"正在生成图片"的提示
2. **流畅交互**：对话过程完全不受影响
3. **自动更新**：场景图片会悄然更新为新内容
4. **渐进式体验**：图片内容逐渐丰富和发展

### 技术优势

- **异步处理**：后台线程生成，不阻塞主流程
- **智能触发**：基于对话轮次的自动判断
- **增量更新**：每次都基于完整的对话历史
- **资源优化**：避免频繁生成，平衡体验和性能

## 📊 实现细节

### 后端改动

1. **SchedulerAgent**：

   - 添加 `generate_background_image()`方法
   - 添加 `get_current_image_path()`方法
   - 使用线程池后台执行图片生成
2. **ScriptSystem**：

   - 添加轮次计数和触发检查逻辑
   - 每3轮自动触发图片生成
3. **ElectronBridge**：

   - 在AI回应完成后检查并触发生成
   - 添加 `/api/get-scene-image-url`接口

### 前端改动

1. **ApiService**：

   - 添加 `getLatestSceneImage()`方法
2. **ChatInterface**：

   - 添加定时检查最新图片功能
   - 剧本创建后自动启动图片更新检查
   - 组件卸载时清理定时器

## 🔧 配置选项

### 可调整参数

- **生成间隔**：默认3轮，可在 `ScriptSystem`中修改
- **检查频率**：默认10秒，可在前端组件中调整
- **图片质量**：8K高清，电影级画质

### 控制台输出

```
📊 第1轮：距离下次图片生成还有 2 轮
📊 第2轮：距离下次图片生成还有 1 轮
🎨 第3轮：触发后台图片生成 (上次生成：第0轮)
🖼️ 后台正在生成图片...
✅ 后台图片生成完成：./output/3/xxx.png
🖼️ 检测到新的场景图片，正在更新...
```

## 🎭 效果预期

### 剧情发展示例

**初始场景**：火烧赤壁的江面，船只整齐排列

**第3轮后**：黄盖的船只开始靠近曹军，火光初现

**第6轮后**：大火熊熊燃烧，曹军船只慌乱，诸葛亮在远处观望

**第9轮后**：赤壁之战的决定性时刻，各角色处于关键位置

每次更新都会根据对话发展调整场景细节，让用户感受到剧情的真实推进！
